# VoiceNoteLM デプロイシステム構成図

## 全体構成

```plantuml
@startuml
skinparam backgroundColor #FFFFFF

title VoiceNoteLM 全体構成図

actor "ユーザー" as users

cloud "インターネット" as internet

rectangle "Vercel" as vercel #E8F5E9 {
  component "React Native Web\n(Expo)\nvoicenotelm.app" as frontend
}

rectangle "Cloudflare" as cloudflare #FFF3E0 {
  component "DNS + SSL\napi.voicenotelm.app" as dns
}

rectangle "AWS VPC (Default)" as vpc #E3F2FD {
  node "EC2 (t3.micro)\nSpring Boot + Nginx" as ec2
  database "RDS PostgreSQL\ndb.t4g.micro" as rds
}

rectangle "Google Cloud" as gcp #FCE4EC {
  component "Google OAuth" as oauth
  component "Speech-to-Text" as stt
  component "Gemini 2.0 Flash" as gemini
}

users -down-> internet
internet -down-> vercel : HTTPS
internet -down-> cloudflare : HTTPS
cloudflare -down-> ec2 : HTTP (80)
frontend -down-> cloudflare : API
ec2 -down-> rds : :5432
ec2 -right-> oauth
ec2 -right-> stt
ec2 -right-> gemini

@enduml
```

## 外部サービス連携

```plantuml
@startuml
skinparam backgroundColor #FFFFFF

title 外部サービス連携図

node "VoiceNoteLM Backend\nSpring Boot (Kotlin)" as backend #E3F2FD

rectangle "Google Cloud Platform" as gcp #FCE4EC {
  component "Google OAuth\n認証プロバイダー" as oauth
  component "Google Cloud\nSpeech-to-Text\n音声文字起こし" as stt
  component "Google Gemini\n2.0 Flash\nAI整形" as gemini
}

backend --> oauth : 認証
backend --> stt : 音声送信
backend --> gemini : テキスト整形

@enduml
```

## セキュリティグループ構成

```plantuml
@startuml
skinparam backgroundColor #FFFFFF

title セキュリティグループ構成

rectangle "VPC (Default)" as vpc #E8EAF6 {
  rectangle "backend-sg" as sg1 #E3F2FD {
    node "EC2 (t3.micro)\nbackend\nElastic IP: 固定" as ec2
  }

  rectangle "rds-sg" as sg2 #FFF8E1 {
    database "RDS PostgreSQL\n(db.t4g.micro)\ndatabase\nパブリックアクセス: なし" as rds
  }
}

note right of sg1
  **インバウンドルール:**
  * SSH :22 - マイIP（管理者PCのみ）
  * HTTP :80 - 0.0.0.0/0 (Cloudflare経由)
  * カスタム :8080 - 0.0.0.0/0
end note

note right of sg2
  **インバウンドルール:**
  * PostgreSQL :5432
    - backend-sg
      （EC2からのみ）
end note

sg1 -down-> sg2 : :5432\n(内部通信のみ)

@enduml
```

## データフロー

### 1. ユーザー認証フロー

```plantuml
@startuml
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2

title ユーザー認証フロー

actor "ユーザー" as user
participant "Vercel\n(React Native Web)" as vercel #E8F5E9
participant "Google OAuth" as oauth #FCE4EC
participant "EC2\n(Spring Boot)" as ec2 #E3F2FD

user -> vercel : 1. ログインボタンクリック
vercel -> oauth : 2. OAuth認証リクエスト
oauth -> user : 3. Googleログイン画面表示
user -> oauth : 4. 認証情報入力
oauth -> vercel : 5. ID Token返却
vercel -> ec2 : 6. ID Token送信
ec2 -> ec2 : 7. Token検証
ec2 -> vercel : 8. JWT発行
vercel -> user : 9. ログイン完了

@enduml
```

### 2. 音声文字起こしフロー

```plantuml
@startuml
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2

title 音声文字起こしフロー

actor "ユーザー" as user
participant "Vercel\n(Web)" as vercel #E8F5E9
participant "EC2\n(Backend)" as ec2 #E3F2FD
participant "Google\nSpeech API" as stt #FCE4EC
participant "Google\nGemini" as gemini #FCE4EC

user -> vercel : 1. 録音開始
vercel <-> ec2 : 2. WebSocket接続

group リアルタイム文字起こし
  user -> vercel : 3. 音声データ
  vercel -> ec2 : 4. 音声ストリーム
  ec2 -> stt : 5. 音声送信
  stt -> ec2 : 6. テキスト返却
  ec2 -> vercel : 7. リアルタイム文字起こし
  vercel -> user : 表示
end

user -> vercel : 8. 録音終了
vercel -> ec2 : 終了通知
ec2 -> gemini : 9. AI整形リクエスト
gemini -> ec2 : 10. 整形済みテキスト
ec2 -> vercel : 11. 結果送信
vercel -> user : 12. 整形結果表示

@enduml
```

## コンポーネント詳細

### Frontend (Vercel)

| 項目 | 値 |
|-----|---|
| フレームワーク | React Native Web / Expo |
| ホスティング | Vercel |
| ドメイン | voicenotelm.app |
| SSL | Vercel自動SSL |
| ビルド | 自動（Git push時） |

**環境変数:**
| 変数名 | 値 |
|-------|---|
| `EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID` | Google OAuth Client ID |
| `EXPO_PUBLIC_API_BASE_URL` | `https://api.voicenotelm.app` |
| `EXPO_PUBLIC_WS_BASE_URL` | `wss://api.voicenotelm.app` |

### Backend (AWS EC2)

| 項目 | 値 |
|-----|---|
| インスタンスタイプ | t3.micro |
| AMI | Amazon Linux 2023 |
| Java | Amazon Corretto 21 |
| フレームワーク | Spring Boot (Kotlin) |
| パス | `/opt/voicenotelm/` |
| サービス管理 | systemd (voicenotelm) |

### Database (AWS RDS)

| 項目 | 値 |
|-----|---|
| エンジン | PostgreSQL 16 |
| インスタンスクラス | db.t4g.micro |
| ストレージ | 20 GiB gp2 |
| 自動バックアップ | 無効 |
| パブリックアクセス | なし |
| データベース名 | voicenotelm |

### Nginx設定

```nginx
server {
    listen 80;
    server_name api.voicenotelm.app;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket対応
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
}
```

## DNS設定 (Cloudflare)

| レコード | タイプ | 名前 | 値 | Proxy |
|---------|-------|------|-----|-------|
| API | A | api | EC2 Elastic IP | DNS only (灰色) |
| Frontend | CNAME | @ | cname.vercel-dns.com | DNS only (灰色) |
| Frontend | CNAME | www | cname.vercel-dns.com | DNS only (灰色) |

## 想定コスト (月額)

| サービス | 費用 |
|---------|------|
| EC2 t3.micro | 無料枠（750時間/月） |
| RDS db.t4g.micro | 無料枠（750時間/月） |
| Elastic IP | 無料（EC2起動中） |
| Vercel | 無料（Hobby） |
| Cloudflare | 無料 |
| **合計** | **$0〜5** |

## 運用コマンド

### EC2操作

```bash
# SSH接続
ssh -i <your-key.pem> ec2-user@<Elastic IP>

# アプリケーション再起動
sudo systemctl restart voicenotelm

# ステータス確認
sudo systemctl status voicenotelm

# ログ確認
sudo journalctl -u voicenotelm -n 50 --no-pager

# メモリ確認
free -h
```

### RDS接続

```bash
# EC2経由でRDSに接続
psql -h <RDSエンドポイント> -U <username> -d <database>
```

### デプロイ手順

```bash
# ローカルでビルド
cd voicebooklm-backend
./gradlew bootJar

# EC2に転送
scp -i <your-key.pem> build/libs/*.jar ec2-user@<IP>:/path/to/app.jar

# EC2で再起動
sudo systemctl restart voicenotelm
```
